<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluación Académica</title>

<style>
:root {
    --primary:#2c3e50;
    --success:#27ae60;
    --danger:#e74c3c;
    --background:#f4f7f6;
}
body{
    font-family:'Segoe UI',sans-serif;
    background:var(--background);
    padding:20px;
}
.container{
    max-width:900px;
    margin:auto;
    background:white;
    padding:30px;
    border-radius:8px;
    box-shadow:0 4px 6px rgba(0,0,0,0.1);
}
.question-card{
    margin-bottom:25px;
    padding:20px;
    border-left:5px solid var(--primary);
    background:#f9f9f9;
}
.option{
    margin:8px 0;
    padding:12px;
    border:1px solid #ddd;
    border-radius:4px;
    cursor:pointer;
    display:flex;
    align-items:center;
}
.option input{
    margin-right:10px;
}
.selected{
    background:#e8f0fe;
    border-color:#3498db;
}
button{
    background:var(--primary);
    color:white;
    border:none;
    padding:12px 20px;
    border-radius:4px;
    cursor:pointer;
    margin-top:10px;
}
.badge{
    font-size:0.8em;
    padding:3px 8px;
    border-radius:10px;
    background:#eee;
    margin-left:10px;
}
.hidden{display:none;}
input[type="text"]{
    padding:8px;
    width:100%;
    margin-bottom:15px;
}
</style>
</head>
<body>

<div class="container">
<h1>Evaluación Académica</h1>

<label>Nombre del estudiante:</label>
<input type="text" id="studentName" placeholder="Ingrese su nombre">

<div id="quiz-container" class="hidden">
    <div id="questions-area"></div>
    <button id="submit-btn">Finalizar y Calificar</button>
</div>

<div id="result-container" class="hidden">
    <h2>Resultados</h2>
    <p id="score-text" style="font-size:1.4em;font-weight:bold;"></p>
    <button onclick="location.reload()">Reiniciar</button>
</div>
</div>

<script>

let allQuestions = [];
let startTime;

window.addEventListener('DOMContentLoaded', () => {
    loadDefaultFile();
});

function loadDefaultFile(){
    const url = "https://raw.githubusercontent.com/USUARIO/REPOSITORIO/main/preguntas.txt";

    fetch(url)
    .then(response => response.text())
    .then(text => {
        parseAiken(text);
        startQuiz();
    })
    .catch(err => {
        alert("Error cargando archivo desde GitHub");
        console.error(err);
    });
}

function parseAiken(text){
    const lines = text.split(/\r?\n/);
    let currentQ = null;

    lines.forEach(line=>{
        line=line.trim();
        if(!line) return;

        if(line.startsWith('ANSWER:')){
            const ansRaw=line.split(':')[1].trim();
            currentQ.answer=ansRaw.split(/[\s,]+/).filter(x=>x);
            currentQ.isMultiple=currentQ.answer.length>1;
            currentQ.id=allQuestions.length;
            allQuestions.push(currentQ);
            currentQ=null;
        }
        else if(/^[A-Z][\.\)]/.test(line)){
            currentQ.options.push({
                letter:line[0],
                content:line.substring(2).trim()
            });
        }
        else{
            currentQ={
                question:line,
                options:[]
            };
        }
    });
}

function startQuiz(){
    document.getElementById('quiz-container').classList.remove('hidden');
    renderQuestions();
    startTime = new Date();
}

function renderQuestions(){
    const area=document.getElementById('questions-area');
    area.innerHTML='';

    allQuestions.forEach((q,index)=>{
        const div=document.createElement('div');
        div.className='question-card';

        const typeText=q.isMultiple?
        '<span class="badge">Selección Múltiple</span>':
        '<span class="badge">Selección Única</span>';

        div.innerHTML=`<p><strong>${index+1}. ${q.question}</strong>${typeText}</p>`;

        q.options.forEach(opt=>{
            const label=document.createElement('label');
            label.className='option';
            const inputType=q.isMultiple?'checkbox':'radio';

            label.innerHTML=`
            <input type="${inputType}" name="q${q.id}" value="${opt.letter}">
            ${opt.letter}) ${opt.content}
            `;

            label.onclick=()=>{
                if(!q.isMultiple){
                    label.parentElement.querySelectorAll('.option')
                    .forEach(el=>el.classList.remove('selected'));
                }
                setTimeout(()=>{
                    label.classList.toggle('selected',
                    label.querySelector('input').checked);
                },10);
            };

            div.appendChild(label);
        });

        area.appendChild(div);
    });
}

document.getElementById('submit-btn').addEventListener('click', showResults);

function showResults(){

    const studentName=document.getElementById('studentName').value.trim();
    if(!studentName){
        alert("Debe escribir su nombre");
        return;
    }

    let correctCount=0;

    allQuestions.forEach(q=>{
        const selected=Array.from(document.querySelectorAll(`input[name="q${q.id}"]:checked`))
        .map(el=>el.value).sort();

        const expected=[...q.answer].sort();

        if(JSON.stringify(selected)===JSON.stringify(expected))
            correctCount++;
    });

    const total=allQuestions.length;
    const percentage=((correctCount/total)*100).toFixed(1);
    const endTime=new Date();
    const duration=Math.floor((endTime-startTime)/1000);

    document.getElementById('quiz-container').classList.add('hidden');
    document.getElementById('result-container').classList.remove('hidden');
    document.getElementById('score-text').innerText=
    `Resultado: ${correctCount}/${total} (${percentage}%)`;

    sendToGoogleSheets({
        name:studentName,
        correct:correctCount,
        total:total,
        percentage:percentage,
        duration:duration
    });
}

function sendToGoogleSheets(data){

fetch("URL_WEBAPP",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
})
.then(res=>res.json())
.then(res=>console.log("Guardado en Sheets"))
.catch(err=>console.error("Error:",err));

}

</script>
</body>
</html>

